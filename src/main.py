###########
# Imports #
###########
import os
import argparse
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from lightfm.evaluation import auc_score
from lightfm.evaluation import precision_at_k
from lightfm.evaluation import recall_at_k
from lightfm.cross_validation import random_train_test_split
from lightfm.data import Dataset
from lightfm import LightFM

####################
# Helper functions #
####################

def ratio(x):
    try:
        x = float(x)
    except ValueError:
        raise argparse.ArgumentTypeError("%r not a floating-point literal" % (x,))
    if x < 0.0 or x > 1.0:
        raise argparse.ArgumentTypeError("%r not in range [0.0, 1.0]"%(x,))
    return x

#########
# Setup #
#########
cwd = os.getcwd()
parser = argparse.ArgumentParser(description='Movie rating prediction')
parser.add_argument('-t', '--type', choices=['random', 'popular', 'consensus', 'controversial', 'none'], default='none', help='Type of sample selection')
parser.add_argument('-s', '--samples', type=int, default=3, help='Amount of sample selection')
parser.add_argument('-r', '--ratio', type=ratio, default='0.1', help='Fairness considuration ratio in a fair prediction')
parser.add_argument('-k', '--k', type=int, default=10, help='Amount of top results to compare')
parser.add_argument('-o', '--output', choices=['machine', 'human'], default='human', help='Output format')
args = parser.parse_args()
number_of_samples = args.samples
outputs = []
popular = [2858,260,1196,1198,2028,593,527,318,2762,2571,858,608,1197,110,1210,589,1617,296,50,2396,1270,2997,1240,1193,356,1,912,1214,1221,541,457,1097,1265,919,1136,3578,1213,1200,480,750,2716,1259,3114,1580,1036,1387,1291,924,1704,908,1610,1225,1304,1307,2791,2804,2918,1252,1247,2959,34,904,923,1219,2324,1230,1278,3471,111,1394,1208,913,2355,2000,1089,32,1358,2599,3147,1961,1222,1234,2916,1968,1784,150,223,3175,1148,590,1242,1206,969,1207,1288,2692,1233,1250,1079,2797,1374,3481,3421,1220,47,1090,1923,3793,1294,2987,3897,1258,1127,3671,3751,1276,1204,920,903,2194,3408,1073,1266,910,588,1954,1584,1641,1674,1393,2395,293,1267,3363,1199,745,3160,2268,2706,2019,733,2336,364,2700,899,3418,1262,953,1953,1080,2289,595,3006,377,1201,2248,1356,2406,1500,3753,2628,357,3361,1299,1028,1721,1094,36,380,780,1527,2291,2947,1673,1682,2908,592,1246,17,2064,1517,1282,2302,246,39,2174,3527,21,1997,2529,6,2890,1035,11,3552,1272,1235,1231,1732,2321,1625,1947,1228,474,1203,1396,3448,1408,1172,3256,1269,2329,2081,1287,3435,1244,1263,3543,3072,349,440,1293,1653,3683,2115,1215,898,2300,1084,1639,2020,539,3255,3210,3362,1060,1376,1952,1249,914,2352,3499,1077,1912,778,265,1256,1748,2502,551,1284,2944,3702,2761,3052,3911,529,3504,922,2968,1302,2763,1179,1212,3703,2080,3039,1101,3424,2871,2948,800,2353,3148,3253,597,3176,2501,497,648,1945,2640,1285,3104,1333,235,594,1223,1188,25,1253,3396,1608,2186,1275,720,1248,3526,3510,1663,1960,2359,2580,3037,1370,902,555,1183,2872,2067,1292,1104,3108,3095,2243,1254,337,2108,2160,2288,930,2664,1466,1962,3386,1573,3730,2949,3359,2542,2686,2391,587,1296,3468,2683,2985,2006,2001,3081,161,58,1224,3948,316,2915,1994,2078,3360,16,2407,3101,300,3105,1449,162,2917,2951,3624,916,2671,1965,2788,2144,1407,926,1095,1957,2150,508,1956,2100,1729,2076,3044,3334,951,2366,994,1041,1909,3555,933,2058,3735,1921,2662,3035,3196,3654,553,955,2973,10,968,905,1271,954,1283,1380,2455,866,3100,3317,3868,909,2333,928,3060,165,1834,2140,2313,2795,1343,2863,3098,1217,1261,2966,454,441,1777,1747,1357,838,1022,628,1257,2018,1185,2728,3178,3246,29,3083,2109,2278,3174,2161,1274,1885,368,2010,247,515,1321,1129,306,509,1372,1086,1959,2137,1092,1635,1019,3916,3507,1260,3545,3763,1944,3699,1537,1719,2011,2193,3811,2648,3000,3252,1678,1950,2087,1029,2490,2470,3088,253,2167,3476,2739,3019,3107,562,678,1722,3508,345,471,1300,62,3462,3307,141,596,3168,329,232,3265,3551,1103,1175,940,1237,1680,785,1032,1147,1411,3429,3536,2398,3159,3479,1301,1907,2096,911,950,1982,1245,1645,1955,104,2657,2005,2371,3755,2273,2565,1967,500,915,342,942,1238,1569,1303,2919,3260,3198,3608,1186,2105,3152,1345,3469,741,1694,3062,3089,3201,3836,1178,3949,610,1189,2085,3203,339,1096,3450,1344,1485,2819,3267,2394,367,1597,1375,3068,353,3082,3629,151,3668,1280,3809,2617,3685,1958,2912,3451,1277,1243,1927,2427,2707,2132,2424,348,3067,2139,1297,2294,1078,2746,671,3505,3512,1171,2841,3358,2423,3952,3030,1914,266,1124,1125,2303,3007,3681,2125,3498,2203,2572,708,2859,3635,2528,2687,524,900,1218,2467,3639,1883,2318,945,599,2065,1131,2993,3467,971,2013,3022,475,2021,2393,3893,2921,1805,272,2012,2857,3271,1093,1132,52,2357,446,2312,2690,965,1264,3298,832,921,1949,1211,1081,2527,307,2023,1120,3365,125,1939,1963,3328,3397,543,2971,531,3741,538,2138,3623,3591,3871,314,431,1350,2118,3033,3034,1042,1552,2145,112,2130,1251,1693,3819,2046,2991,3071,1298,163,180,2731,3087,535,428,2770,3801,319,647,661,1964,1476,2539,2677,3061,3733,3740,3783,3844,492,1587,3005,2401,534,1594,2070,1226,3020,3070,1348,2208,3494,1378,3461,41,1643,1931,45,1339,3548,2390,3301,3524,2403,3742,1845,2946,3244,3675,3814,1281,373,3134,3384,101,1354,2433,2670,1347,2009,2301,2463,1023,2134,164,3366,1088,1441,2779,3097,3163,1917,2245,2989,802,1012,949,1047,2231,69,947,1227,2003,3347,3261,3556,3634,333,1061,2420,3186,3549,906,2745,1066,2002,3745,805,350,3090,3129,3927,2202,934,1946,2117,1446,2750,3788,249,292,1340,1810,1873,2644,2311,3723,308,3576,736,1361,3189,1059,1099,2693,3342,2712,28,7,176,931,3789,3873,261,3135,514,3341,73,1672,3827,493,3091,3706,222,932,2922,198,1025,1916,1209,1289,1589,1633,2114,2936,3074,2729,3516,3932,2141,2935,2015,2454,2941,3398,3863,2176,144,1948,2112,2206,943,1797,2348,2764,1286,2183,2734,728,1683,1734,412,3521,2282,3185,3910,3300,3633,556,952,1017,1392,194,507,1649,3296,3546,1711,2071,2083,3153,3606,3770,3812,230,2474,2881,3102,2926,1619,1676,3798,290,1268,1031,1057,1688,2360,2384,2726,2883,224,281,1295,2759,262,918,1754,322,1518,1876,1892,2133,3111,3259,581,1049,1951,2414,2612,1150,3250,3501,3760,1013,1177,2116,3200,3513,3929,1279,2622,2732,3093,3682,3698,3852,233,494,3700,70,2583,936,3420,3728,2,1273,1615,2575,861,986,2469,3364,3724,2518,2641,2952,3350,653,1913,3155,3535,448,946,2866,3618,714,852,1290,1459,3066,2022,2171,3204,2351,2937,3684,3831,1620,2099,2611,2867,22,94,2442,892,1419,1566,2496,2605,3441,213,3169,3213,215,549,1033,1542,3475,1730,1966,3079,231,552,3263,3405,2889,2943,3409,3638,1385,2541,317,1942,2236,2287,154,2066,3470,280,1176,2124,2240,2439,2660,2852,2924,3032,1050,1614,3466,3704,2826,2920,3182,3614,799,1701,2090,3018,3653,3538,938,3181,344,2870,3219,361,2068,2932,3566,3701,24,481,901,3247,3617,1479,1938,2624,2747,2757,2905,3747,663,1935,2069,2405,2413,1034,2232,1082,1192,1371,2940,3077,145,1236,2212,2310,2330,2694,2927,1835,3028,3925,175,2159,2581,2600,3167,3251,3686,3727,837,2097,2476,1111,1362,1884,3125,1069,1085,1660,1827,2349,2654,2929,3744,288,417,1194,3078,3266,123,1414,236,252,2457,3404,147,334,616,948,2688,2736,3040,907,1187,2110,3269,3480,1046,1305,1395,2143,2363,199,299,468,2803,2967,978,1020,1918,2970,86,456,482,2682,2730,3145,3179,3676,1648,2346,2550,3729,477,586,1429,1941,2891,3011,3928,105,3379,991,1161,3038,3096,351,1205,1799,2184,3478,362,783,1083,1162,1484,1788,2340,2376,2633,376,2596,3094,2344,3604,3872,2155,3422,3712,14,1611,2969,326,927,1306,1401,2609,3330,3598,999,1015,1940,3224,3936,2094,2983,670,2409,2669,3357,3406,3679,82,85,363,574,1545,1699,1934,2553,2724,3157,523,944,1135,1792,2990,60,2025,2059,2077,2102,2879,3197,190,973,2166,2443,2875,3430,3615,43,897,941,1480,2607,2672,3565,627,929,1184,1895,2204,2370,2488,3529,3769,383,1416,1936,2239,2436,3859,605,1900,2111,2511,2725,3016,3327,3613,302,615,1785,2347,2925,3622,1173,2988,3519,3550,848,3075,3678,491,517,1190,1897,2181,2478,2901,3194,372,668,1554,1875,1929,2972,3076,216,759,1010,1758,1794,2048,2431,2721,3099,3412,3503,3599,3915,3926,425,450,2238,2899,3882,346,748,851,2178,3713,388,1465,2173,1840,2567,2570,2846,3173,3456,3506,3547,490,1130,2075,2295,3771,72,2495,2594,3746,434,3308,3720,501,766,786,1216,2182,2996,3270,3275,3896,3930,506,1027,2506,2696,3726,206,381,483,982,1014,1904,2106,2437,2459,2551,3594,229,289,1009,2280,2782,2861,3015,3554,3787,18,26,171,1735,2261,2416,3822,205,613,917,3029,3230,3447,1464,2029,2262,2272,3281,3627,117,1535,1759,2276,2718,3142,3444,3525,3528,3649,3737,1365,1425,3310,3487,30,282,635,893,1727,2135,2285,2334,2836,3416,3571,170,449,522,700,2024,2089,2801,3086,3264,3274,3452,3920,321,602,1334,1544,1858,1937,2249,3249,3786,116,935,2621,3069,3502,3658,3808,3849,225,1202,1769,2073,2453,3643,3680,80,521,959,1571,1889,2043,3417,188,650,1180,1684,1836,2475,3046,3426,3628,3870,1051,1397,1670,1821,2165,2585,2618,2709,3150,3368,57,242,1546,1753,1925,2331,2976,3036,3289,3677,3792,121,781,803,1689,2146,2708,2710,2848,3338,3655,3739,3784,3823,107,371,1824,2210,2297,2361,2434,2810,3188,3241,3851,3869,149,156,1616,1870,3008,3370,155,724,735,1337,2425,2610,2676,2738,2942,3515,3950,3951,214,1320,1513,2645,2697,2774,2874,3118,3222,3272,3738,421,1016,1516,1860,2247,2284,2290,2661,3211,3371,3794,3865,97,159,279,309,465,937,1232,2033,2136,2323,2639,2860,2880,3206,3284,3534,3539,324,390,715,976,1008,1346,2014,2493,3002,3055,3214,3217,3304,3339,277,746,963,1018,1024,1910,2057,3372,3736,3917,568,621,705,1564,1865,2665,2820,2847,3133,207,269,1457,1586,1631,1809,2037,3791,3807,3816,40,846,2499,2702,2753,3158,3183,3734,68,81,669,1056,1654,2494,2613,2802,3445,3795,13,77,257,341,824,988,1169,1687,2237,2275,2337,2520,2681,2744,2928,2939,3112,3192,3311,3855,3903,3947,187,218,1030,1054,1241,1844,2045,2593,2620,3199,3427,3861,263,358,423,458,461,695,707,1068,1123,1310,1390,1541,1563,1588,1621,2554,3132,3619,3632,3813,83,99,140,340,408,665,680,1076,2579,2634,2938,3128,3143,3171,3306,3318,3320,3425,3914,35,426,722,896,956,1255,1695,1922,2131,2151,2271,2519,2714,2885,3117,3329,3375,298,1399,1409,1482,1533,1812,2481,2485,2630,2649,3010,49,268,335,571,764,850,862,964,1366,1415,1658,1879,1919,2320,2432,2573,2626,2843,3092,3559,3707,3846,211,532,583,649,1405,1413,1423,1572,1627,2180,2533,2560,2749,2813,2842,2956,3415,3612,3637,3718,3790,46,369,659,702,1067,1412,1447,1498,1612,2104,2177,2263,2512,2711,3115,3302,89,760,808,831,875,1367,1650,1661,1669,1686,1725,1801,1859,1866,1943,2205,2440,2517,2766,2769,3731,31,128,328,352,451,495,511,537,718,1353,1696,1755,1893,2086,2325,2345,2430,2447,2689,3309,3367,3446,3532,3585,3588,453,488,580,970,1112,1117,1151,1596,2175,2187,2189,2503,2727,2780,2844,3806,53,183,389,681,771,1152,1351,1507,1509,1511,2062,2314,2419,3109,3567,3670,78,301,320,632,835,1191,1428,1454,1974,2197,2784,2822,2824,2839,2904,2931,3110,3127,3137,3138,3144,3414,3489,3496,3569,3625,3854,96,354,365,394,443,633,645,691,801,974,1144,1398,1472,1475,1477,1547,2049,2084,2305,2341,2651,2963,3221,3223,3410,3477,3756,203,391,452,467,573,617,961,1154,1404,1406,1450,1487,1508,1880,1928,2074,2098,2227,2781,2812,2981,3045,3122,3124,3399,3537,3586,3645,3810,3845,3858,598,806,841,997,1002,1044,1582,1657,1713,1743,1874,1932,2185,2211,2482,2647,2776,2834,3047,3121,3349,3473,3514,178,184,241,271,503,536,685,957,960,1331,1733,1770,1780,1811,1814,1898,2056,2250,2598,2723,2743,2896,3049,3161,3240,3245,3495,3570,3714,3759,3880,3,100,347,496,513,561,565,567,751,811,1087,1504,1848,1933,2079,2101,2128,2201,2342,2418,2435,2577,2659,2772,2837,3073,3333,3402,3492,3659,3725,3776,103,106,182,422,755,864,877,1006,1116,1119,1312,1317,1420,1422,1442,1529,1531,1570,1728,1807,1906,2156,2388,2397,2562,2569,2582,2756,2923,2930,2998,3282,3283,3568,3711,3785,3853,3905,189,210,674,709,787,860,962,966,967,1138,1153,1585,1664,1926,2035,2129,2168,2179,2215,2293,2466,2627,2666,2673,2830,3053,3106,3218,3644,3832,118,251,304,375,406,560,570,753,767,854,863,958,1026,1384,1493,1741,1846,1896,1901,2157,2281,2444,2524,2540,2561,2625,2897,2913,2994,3232,3292,3497,3605,3640,3775,3796,3803,3906,3943,37,90,129,219,294,359,385,525,563,638,844,869,1063,1174,1369,1496,1534,1567,1642,1671,1749,1804,1856,1871,2047,2061,2219,2304,2358,2663,2675,2699,2775,2833,2933,2962,2964,2975,2984,2999,3012,3025,3056,3103,3140,3154,3233,3351,3443,3609,3657,3780,3867,3894,55,124,167,254,270,297,404,439,550,557,578,757,769,853,925,985,1038,1058,1164,1444,1656,1685,1795,1902,2103,2209,2252,2299,2309,2480,2538,2632,2678,2704,2760,2768,2877,3126,3139,3141,3303,3319,3345,3474,3517,3522,3749,3817,3860,3885,3888,3902,5,84,130,134,136,331,682,729,775,939,989,1039,1071,1139,1149,1434,1437,1471,1519,1543,1575,1629,1830,1842,1851,1857,1872,1899,1903,2127,2192,2198,2332,2510,2557,2578,2590,2615,2767,2811,2831,2911,3003,3050,3057,3120,3172,3215,3242,3280,3293,3305,3353,3382,3419,3483,3533,3580,3601,3607,3656,3848,3862,3881,8,67,114,131,139,197,264,396,398,409,530,584,624,666,679,696,701,712,717,758,774,791,792,796,820,823,874,878,972,993,998,1000,1121,1316,1349,1360,1364,1421,1463,1470,1486,1502,1561,1652,1675,1787,1832,1833,1854,1861,1915,2031,2172,2195,2221,2223,2251,2438,2441,2543,2635,2658,2741,2785,2800,2865,2909,3065,3084,3131,3164,3207,3216,3229,3236,3277,3295,3314,3337,3377,3378,3381,3413,3486,3523,3530,3531,3562,3575,3603,3611,3642,3647,3719,3866,3934,33,61,137,152,192,245,283,286,311,401,402,559,572,576,582,600,601,603,623,657,658,664,687,726,734,756,763,776,789,790,807,814,827,868,872,884,1040,1070,1113,1134,1330,1555,1565,1579,1715,1724,1764,1767,1817,1829,1843,1908,1930,2214,2226,2258,2326,2556,2563,2584,2592,2619,2685,2703,2895,3136,3184,3187,3235,3288,3290,3323,3336,3380,3458,3482,3542,3587,3595,3620,3652,3748,3752,3779,3842,3874,3886,3887,3890,3935,108,113,120,138,226,545,566,579,630,642,644,651,652,706,732,749,754,859,865,887,889,980,981,1062,1118,1145,1163,1181,1436,1510,1548,1553,1630,1659,1709,1714,1773,1815,1820,1852,1886,2060,2207,2218,2235,2254,2257,2277,2308,2378,2426,2484,2507,2586,2602,2623,2691,2742,2773,2789,2821,2825,2869,2960,3085,3151,3212,3220,3291,3294,3297,3315,3321,3322,3346,3352,3373,3449,3457,3602,3631,3722,3732,3761,3778,3828,3847,3850,3875,59,127,133,142,146,287,310,577,591,607,641,655,662,672,684,690,730,821,826,843,977,1115,1133,1165,1315,1386,1430,1514,1528,1532,1539,1574,1651,1791,1850,1868,1877,1888,2017,2039,2191,2213,2217,2339,2343,2472,2483,2545,2591,2608,2679,2705,2737,2765,2823,2845,2850,3202,3209,3237,3312,3376,3460,3636,3641,3687,3800,3878,3904,3924,74,469,614,643,660,744,876,975,1053,1098,1107,1355,1363,1558,1613,1622,1636,1718,1796,1849,1864,1905,2032,2095,2242,2317,2415,2464,2576,2814,2853,2887,2934,3116,3205,3428,3485,3581,3648,3757,3830,3892,3913,27,384,526,634,698,788,793,834,895,987,1102,1114,1142,1458,1522,1703,1782,1816,1890,2063,2200,2246,2267,2316,2350,2417,2487,2509,2544,2587,2652,2783,2955,2977,3014,3119,3228,3335,3407,3465,3491,3493,3592,3621,3651,3772,3818,3876,3883,3899,38,148,158,392,411,442,804,828,1007,1055,1160,1455,1841,2283,2631,2646,2758,2777,2864,2893,3021,3149,3262,3472,3672,3708,3762,98,238,313,336,815,886,1433,1549,1551,1583,2400,2638,2740,2849,2892,3123,3374,3423,3490,119,200,237,295,397,569,731,1003,1473,1501,1662,2008,2040,2055,2233,2636,2752,2829,2854,2855,2873,3013,3403,3518,3540,3765,3805,3900,504,618,847,992,1341,1520,1538,1666,1793,2158,2190,2244,2362,2372,2534,2650,2674,3001,3051,3344,3544,3666,3937,3944,48,56,243,716,1332,1581,1677,1692,2234,2695,2809,2914,2945,3395,3777,3891,278,303,433,462,484,554,1167,1417,1494,1891,2260,2292,2356,2377,2546,2653,2751,2755,3058,3597,3721,3837,88,228,244,476,984,1313,1426,1600,1632,1647,1717,1825,1878,2486,2559,2637,2792,3162,3166,3389,3464,3843,201,248,250,386,463,486,498,499,1329,1410,1720,2513,2796,2894,3026,3437,3463,3557,3590,3781,3782,3898,3933,75,240,472,478,619,1128,1746,2778,3027,3454,418,430,626,703,830,1311,1352,1609,1624,2120,2307,2656,2754,3340,3400,3459,3509,3520,3563,202,212,274,378,547,609,1881,2196,2256,2327,2445,2876,3313,3717,63,204,259,447,779,1383,1489,1604,1646,1783,2787,2978,2992,3276,3610,3838,3922,407,656,882,1043,1168,1771,1853,2298,2374,2589,2715,3839,3921,23,54,168,382,885,1668,1798,1806,2535,2884,3691,575,725,867,1440,2038,2148,2164,2771,3553,3674,3940,1822,1837,2322,2492,2530,2856,3804,3857,239,1523,1550,1601,1990,2007,2286,2504,2790,3577,3600,3673,3941,840,1064,1327,1593,1867,2667,3488,3660,3909,512,640,813,990,1170,1432,1756,1989,2566,3165,3239,3797,217,343,459,487,996,1377,2044,2052,2882,3331,135,273,510,1342,1667,1679,1744,2266,2452,2597,2878,2886,3343,3884,76,195,338,387,520,761,1603,2328,2835,2888,2898,3326,3626,3833,3931,325,479,1335,2072,2364,3436,3442,3511,3939,209,460,1382,2091,2123,2497,2733,3431,3434,3596,3912,42,704,881,1324,1328,2241,2446,2523,2552,3696,3758,3938,424,639,1439,1460,1605,2154,2477,2491,2794,2979,3064,3584,414,711,1325,1490,1726,1887,2255,2335,2354,2365,2429,2521,3743,3773,3834,3879,516,1598,1690,1999,2479,166,220,528,564,719,3574,3665,3918,710,1004,1379,1483,2142,2264,2982,3942,9,505,1869,3287,3579,1427,2537,2629,3156,177,275,1011,1911,2016,2505,2862,3355,3901,179,267,291,697,888,1602,2369,3225,3667,445,585,1626,1640,3063,191,330,558,870,1525,2451,3573,879,1322,1456,1488,2082,2093,2465,2536,3433,3692,227,370,1336,1894,2169,2786,2840,3716,410,1497,1655,2868,3390,3393,3669,3820,3864,3923,79,122,366,667,809,2051,2375,3031,3324,4,132,544,743,1988,2306,3048,3453,464,612,1526,2449,2614,2735,379,470,1983,2041,2050,2500,3387,3715,3825,436,2387,3017,157,186,694,1326,2026,2410,3254,416,489,1105,1750,1839,2522,2900,2961,3043,3500,3840,2516,2531,3835,315,2717,3432,533,747,2170,3693,174,2461,2532,3180,438,444,1021,1592,2259,2269,2606,64,92,1826,2655,1438,2805,87,798,1762,2558,437,1987,2152,2188,2386,255,548,842,2107,2385,3895,305,312,765,1468,1665,2462,2515,3208,3385,3695,360,637,833,2279,782,1855,2793,3661,3945,44,2121,2574,3663,3774,542,2034,2113,3177,3316,3919,93,2458,3768,631,1920,3391,3394,3709,276,1323,2054,2402,2965,102,1752,1991,2027,2042,3664,3694,606,1606,1731,332,2806,3146,20,185,1495,2399,2851,3130,3946,2036,2367,2460,3616,3841,3908,256,1985,2368,2722,1091,1739,1980,2149,2974,15,95,3889,1515,518,1100,2163,2548,2818,742,836,1595,2498,3484,258,818,2265,2526,3662,1453,3258,3388,3697,71,2468,3257,3764,3766,1005,2296,3821,3688,1599,1924,1461,1979,2092,2389,415,829,2315,2903,3248,692,3042,1984,2902,3041,3767,1970,3286,196,1474,1975,2373,3572,1503,126,3646,1623,3401,12,3824,784,2147,2162,3754,427,1431,1978,1995,3024,839,1391,1993,2119,3325,2828,2514,1681,2815,169,1863,1986,2807,234,611,2428,2473,413,1981,429,1359,455,466,473,891,2525,3690,1992,2907,393,2408,2448,3299,419,2126,3285,2668,66,181,1445,2122,2748,1772,1996,3004,540,2411,65,1702,2549,3689,3190,327,2379,3710,3799,1977,1998,3054,2799,3243,1388,3564,688,1373,2421,2471,3273,2392,3705,374,432,502,3392,2816,2906,2817,2798,3438,355,1707,420,1644,1973,3802,405,3877,1591,2004,1779,2808,2827,810,1971,2382,1969,3826,1862,2381,2380,2088,2568,2253,172,2456,2404,2616,1126,2383,1972,19,1976,3440,193,2953,1037,3113,435,2713,2555,519,673,1760,3268,3439,2950,3238,2338,2995,208,1590,1389,762,485,2412,849,2422,880,1831,153,2053,2153,737,2719,2986,2720,1381,1499,3354,1882,2642,2643,173,2450,546,1556,160,1562,3593,2701]
consensus = [134,582,657,672,787,827,884,895,977,1070,1134,1139,1142,1311,1434,1842,1851,2343,2811,2895,3057,3123,3126,3228,3233,3305,3336,3353,3493,3601,3651,3687,3574,3027,3166,755,3245,53,1720,3891,726,757,1561,2172,2299,2503,3378,2079,3001,3283,3056,560,2814,2200,1098,1622,2233,2608,2578,3621,3762,120,1039,1315,1861,2223,2510,3242,3352,3373,3631,2905,98,966,3463,1495,1844,3756,121,2486,745,298,2839,3122,1759,1533,722,1144,904,1262,1910,318,1170,3171,2472,439,530,557,578,660,679,712,791,889,975,1062,1145,1364,1510,1548,1558,1795,1905,2251,2309,2480,2543,3084,3131,3212,3295,3337,3377,3381,3410,3413,3485,3517,3888,1148,2357,3347,1323,2852,1198,3634,2824,1509,908,3468,2670,3435,922,1989,2019,406,1444,2464,211,50,3137,930,972,1384,3292,1250,664,1782,3154,1514,3470,1212,1931,3339,1234,3068,3573,2727,635,2577,3801,3427,527,2397,2819,1223,3735,556,2866,1082,2749,3211,2743,324,942,950,3069,178,1770,457,3071,705,746,974,913,2859,3402,3192,1086,1242,1284,3654,474,128,767,1466,858,1224,1889,2757,652,3551,2437,1267,2104,1276,3047,3334,3366,80,3644,3329,2620,3196,1949,117,1950,1412,2347,1280,1207,3733,1193,3370,2988,3222,3429,1739,2194,2186,1929,3089,2612,2922,1147,1807,2923,1674,1537,903,1259,3198,3359,810,2870,2534,3547,260,2762,150,1254,1938,3590,1299,1304,905,2788,720,3643,750,954,1184,232,440,3537,3039,3372,3469,1178,1272,2544,363,1940,909,1531,3682,3507,3926,933,951,300,1672,3897,1472,1942,1203,269,529,1056,2949,928,2074,3384,3341,3345,2474,3281,2237,936,3811,33,756,1532,1871,1903,2358,2685,2999,3609,3666,3876,3887,373,1291,3667,1935,254,3783,994,77,1252,3713,3035,1961,1928,2178,1383,1343,2401,2937,969,3498,2951,645,2201,456,1084,3730,3683,910,647,3927,3256,1204,1840,2855,3282,1225,3090,906,349,1233,2313,1231,2948,1610,911,2944,1303,3060,3307,2753,2176,3635,3038,1953,1810,912,1131,3374,3271,921,1963,1260,3602,475,454,3406,1344,1446,2071,295,3478,331,1675,593,453,2609,1325,628,1704,2756,1643,3362,1236,947,3364,731,1247,2298,3169,1945,1447,649,898,326,2234,3405,3475,2682,926,916,2917,3606,3296,2993,2818,698,1664,1685,3207,3443,1269,3097,246,3613,2210,1324,2873,41,1132,1189,3091,1440,1172,3363,1392,3639,2449,2947,2368,1482,1293,945,1946,385,703,860,3849,1617,214,1196,3037,3836,483,2189,1290,1593,2726,3079,2028,2345,2816,1797,2991,3250,83,1120,1104,1442,2312,1927,3622,3448,3728,1217,375,425,2349,2231,2501,2077,863,869,3763,1197,678,66,3313,2537,2203,931,446,3770,1103,2248,3738,3132,2329,2268,1,1240,3451,1964,2058,971,3204,3937,3030,268,965,1621,281,2921,129,2425,359,2433,3350,1661,1111,176,3614,1253,3311,3006,943,161,492,929,3261,222,149,2442,3105,3681,3096,1944,2100,2208,3044,2066,280,3506,2243,3724,2836,3197,2204,1150,3102,3041,1036,293,1358,2285,3936,428,1222,96,1121,3642,2918,3104,1854,2434,1396,3628,3655,361,3088,2729,1363,11,389,2779,3255,991,941,1270,2406,923,1896,1090,614,3495,3648,1228,1244,3508,3042,2000,806,3445,36,3379,1683,40,164,2697,1003,1221,3203,2778,1019,3814,958,2731,2728,1116,2766,2295,3591,3543,2692,2183,3679,1017,68,2787,3653,3505,28,1213,3576,1278,2370,2802,14,431,3367,2339,914,1136,1542,350,1441,3098,1733,3723,541,2536,3911,244,1826,3570,3789,2130,2662,1449,2271,3062,2300,2989,2841,862,949,3230,915,538,306,1730,2206,3360,3420,3465,319,499,2567,2355,3308,2245,1500,1283,3771,1660,497,1936,3317,430,2919,1307,2055,2481,3567,3061,3803,3067,2470,3075,2302,2114,1682,272,478,1154,1300,3906,3516,2037,1248,2716,892,2736,2057,111,2797,3200,2407,2007,3526,2807,598,1002,3462,3002,2276,3637,2457,2884,376,1187,252,1955,113,89,2943,1892,3557,1322,2374,3684,1556,899,581,1633,2289,2336,3135,447,1219,3029,2420,1264,3480,2414,10,3304,3338,571,1459,1078,1201,3274,3581,3114,3834,3107,1041,1249,3741,3244,1287,1722,167,1504,2930,952,2118,2353,3499,2973,1490,2940,2970,3103,2476,3408,3819,919,605,1909,181,58,1625,452,2177,2952,335,1939,3148,1245,179,1257,3536,3831,2273,2511,1663,3529,3152,847,2610,2966,1422,3471,728,2029,3812,2804,2280,2983,3298,2611,337,64,2144,2080,3519,1077,159,1335,3513,1457,2269,508,1294,1571,3731,20,2145,1841,1719,2108,707,1066,2956,3466,1038,1076,2215,17,1099,589,1494,2896,220,16,3467,2734,953,3019,2915,1025,3087,708,3077,195,3403,3246,948,3588,1162,3219,154,1375,2182,851,3015,1185,1962,3810,1226,3774,2240,544,1952,800,2097,803,35,1729,3932,3022,3474,3860,3504,1393,1631,1968,2475,3129,2138,1485,568,940,2467,2376,1960,1246,1629,1829,1235,1125,1214,2065,2078,2246,2847,1227,52,2565,3898,2669,2473,2518,388,3793,3118,1256,1589,2013,477,1208,3668,3701,3678,1135,2020,2310,437,371,2708,3629,3109,1414,2330,3158,2096,2044,2546,3147,3016,2247,3395,507,832,3111,1390,494,2573,3397,101,2191,1518,2045,2006,3698,2087,3686,3361,2181,3521,412,2494,2001,415,897,1333,3534,3727,1273,2848,470,1179,2348,3385,3859,1266,999,3121,2587,144,1419,383,850,289,3078,230,1595,2321,2360,2580,451,2640,2324,409,1612,3390,1200,1357,668,1079,1686,225,2202,2137,2614,489,2293,1218,3572,2599,1411,612,308,3479,1210,3101,811,3265,3734,2490,2383,3769,3342,1511,131,2920,1423,1898,3685,1265,1956,3401,2539,695,110,1083,102,514,3699,1785,3744,838,3144,2871,1317,3510,271,2750,3813,2571,43,1695,548,2334,3153,2885,1580,3270,1016,1541,1068,292,1093,3214,956,261,86,1007,1680,1177,2046,2851,423,2744,599,3267,2054,831,3494,1080,805,3189,2936,3051,357,1401,2281,6,2752,2267,2469,3578,569,21,3604,2294,3952,307,468,3870,2916,3538,340,1465,1277,3251,3269,613,2010,210,339,61,2754,502,2935,1598,3263,1912,3841,1352,2272,380,2134,2359,1934,2015,3095,519,47,2398,2185,1834,301,852,3649,3081,2391,2761,3120,1268,2396,633,2579,3253,365,2453,3100,2408,3555,1608,554,540,3729,151,3210,741,2422,3764,1616,3705,2607,2842,650,321,534,1994,2509,2262,2874,2763,450,1008,2941,3414,2463,517,314,1437,1263,1821,990,2180,114,1827,1615,1258,2868,249,433,615,1297,621,2535,2745,2405,1998,2883,1069,2418,2187,973,766,1387,2212,372,490,2903,944,3330,1647,422,982,1119,1370,2266,2311,1251,1061,3710,1804,1811,1097,26,3396,866,1127,2528,3141,523,2419,3000,491,596,2795,3481,3178,2558,2879,112,2095,1870,183,3011,608,2523,1784,2805,1596,3130,348,3442,2352,1678,1356,290,2264,3671,3076,2668,3716,1914,2333,1641,1031,3624,1684,3201,934,3199,1057,3675,346,2390,594,640,2125,515,3751,1817,3935,1388,2817,2103,8,1171,278,566,3563,753,1220,1507,2889,1161,141,2496,3882,764,2686,3593,955,1597,2184,2320,588,2561,1006,368,3845,224,3584,1620,3564,3005,432,247,1186,2690,1305,3175,1012,3180,3034,1603,67,404,1758,3472,1488,1693,219,2047,3585,251,3709,2003,2432,277,3559,3714,3046,1033,2654,1399,2132,1395,194,539,1791,902,2555,561,3796,702,2179,1092,2522,2803,2067,3167,513,2146,100,1042,531,2139,2526,1051,733,1374,1060,748,3252,1619,488,2110,564,1029,1954,2946,3094,3301,1288,39,3827,2048,2346,2421,2925,32,2790,2135,302,510,31,1792,2693,364,2987,1129,1302,555,377,2284,1862,1117,2117,1408,93,3418,3872,917,329,3260,2783,3496,463,2642,3110,3691,3497,1948,1020,1885,1124,2025,2466,2615,1285,2990,1516,3848,354,1377,2174,1230,3929,3449,2291,3877,1190,2009,809,2899,3422,1794,480,2872,125,94,563,2471,3712,2812,1022,2575,1085,3426,3704,419,804,1569,186,2735,2835,2699,236,524,3224,760,3518,2278,2070,537,46,1455,122,3082,2524,1271,2341,99,1547,3365,1032,2124,1476,3083,1389,2385,1321,2439,3182,3254,2011,2798,1425,1656,1906,3398,3512,2858,3755,1913,2894,2064,1404,1907,3299,844,1522,1718,1849,2061,1351,2350,2155,3421,2094,2515,833,369,22,648,1024,1911,1735,907,688,426,3852,3791,2252,1237,3066,1777,653,3134,3388,798,2648,2502,1112,3884,521,1301,1292,3633,602,1947,1767,481,7,296,2748,1010,2939,2069,3249,1508,2982,2147,3186,1281,3461,3162,27,3625,3807,279,964,362,1995,1650,3893,2711,2986,387,987,2085,3677,3923,3835,2040,592,2641,479,294,2002,2,1361,732,2664,3049,3527,3546,3417,2791,3389,3450,49,2902,2738,2782,2075,458,2517,2963,227,861,276,189,3788,2331,3128,500,2605,424,378,3680,228,1044,3259,2141,1394,2717,2815,2394,2570,1365,3539,662,3550,2043,535,2283,3802,498,1688,291,2327,2140,3190,262,1345,2581,1175,3425,3168,997,1362,1096,3424,2409,2572,493,2400,3487,900,1747,1520,1498,2616,2527,2455,1545,1687,2207,3905,2089,1089,3386,2553,2485,2688,2598,3916,802,2967,2770,3610,3871,1274,3773,3638,1833,2014,2255,3909,2344,2846,3702,762,3217,2068,2111,163,2985,1526,303,2643,85,1209,2618,2241,2759,2568,1181,243,393,3025,2477,1192,552,1275,287,1893,1599,2890,3074,2671,1668,2737,2624,2969,2090,864,3640,2429,342,2112,2740,3919,2849,1130,2927,2968,29,1653,835,60,1238,212,609,3501,3580,3072,2860,1176,1894,1429,185,2261,1632,2865,1188,196,1788,1279,3556,1679,533,1296,2441,209,2540,2542,1167,459,245,623,643,734,744,853,1040,1107,1564,1657,1741,1878,2444,2576,2631,3184,3187,3482,3522,3063,2912,2891,2822,2613,694,265,79,959,3806,3155,2115,1875,3032,23,316,516,2133,2290,2193,1943,2799,1572,3040,1480,918,2714,2677,1865,3055,2018,1346,2758,2288,1996,2867,45,3264,2456,1081,893,2120,3548,3669,2417,1094,2458,1550,3502,2707,1337,2382,2375,3452,2445,299,322,165,932,2259,248,3524,414,2863,3846,836,384,2381,263,2493,1584,3240,1614,3436,1864,3116,505,3708,2017,57,237,2971,3925,1028,3239,3949,2109,1473,345,2622,3179,1376,2585,1011,356,3392,1966,3618,3138,160,3441,619,2898,759,223,259,627,2380,391,215,3268,3045,30,2583,1583,2196,235,355,2393,3358,1639,158,4,1752,274,1432,2488,946,3525,410,2415,3948,522,218,2249,62,132,2371,1967,1043,3767,379,2081,92,2126,2932,786,1073,1748,18,467,673,2366,2978,3099,3394,1378,927,1336,2659,2672,1857,3473,3206,986,1515,3615,3703,3931,2784,3368,229,2997,2908,3387,1879,3599,2479,1972,1484,590,782,779,3161,2945,434,2142,1513,42,2086,2725,473,2928,3491,2789,783,3732,3174,2829,724,778,438,3895,3694,2053,1152,476,1987,2150,670,2316,661,73,3440,3500,3711,2529,3020,3241,2465,1919,87,2166,1839,1667,317,3740,1824,3108,156,1988,3605,472,3672,5,3412,2574,2416,3879,1332,3028,1027,2771,2808,799,417,1635,3549,169,1286,1409,1341,2621,2012,441,213,2854,1605,2303,367,1925,3697,1552,543,2369,3157,2171,1413,3258,3809,2403,595,1873,283,338,394,2751,3747,3760,1463,420,1398,1101,3218,2676,3343,305,275,351,3371,1211,76,1760,1860,3284,1013,464,503,638,3945,1642,3430,471,3799,173,547,616,1385,3869,1805,90,681,1519,3657,1538,2687,2083,2034,3792,3391,2367,1191,3145,2136,2379,2880,2950,1769,448,253,2105,413,3010,882,1095,2168,3375,2287,580,1407,1876,3165,2188,1922,2764,1900,2906,962,1746,145,3454,341,2190,1858,2092,3257,901,1754,3247,69,1009,1694,574,3276,3700,2724,2250,2424,1100,34,334,719,1701,2972,3600,1677,725,2082,562,963,3243,1499,1951,2263,3766,3854,1957,95,3289,2428,162,2629,3742,1087,2123,2792,2739,761,924,2073,1971,442,320,1845,603,2175,3007,242,381,2024,606,2062,1372,191,546,3552,2153,1047,597,485,2593,3808,3726,3143,3553,1863,3950,256,2732,455,2236,1711,700,171,1727,3594,2161,153,553,1049,1965,123,3509,2924,3689,3797,2454,9,1050,1783,2242,2881,1594,2634,2720,2702,1397,1673,374,2875,1215,2636,1030,1600,709,44,2746,1937,2942,2531,72,3331,3873,2402,71,2356,587,147,2292,2440,155,3318,2023,3017,1431,328,710,1645,1503,697,482,1671,880,3223,2533,370,2877,198,2410,3765,577,3545,920,416,993,1891,2351,1015,443,206,2639,1340,3213,1023,2099,925,685,2282,13,2323,3832,1168,1199,2525,184,1326,2121,765,1180,3695,617,1658,2530,1563,3951,460,2843,435,2160,1609,998,781,1779,2548,988,1169,3514,3844,2931,88,1350,2038,886,3692,3721,2373,2301,2008,771,2143,1018,813,1853,2317,3248,3664,304,1091,3861,2521,2747,3863,2827,518,436,1713,667,2926,1461,2541,1037,3159,1587,2076,1976,1487,82,204,1959,1921,3476,1064,257,2378,1880,2340,3753,1381,2701,78,3328,3173,1128,3768,2436,3823,3805,2443,504,2974,536,24,1053,1496,3798,2036,2801,1486,3026,3620,3737,3004,1744,715,3316,3423,1623,3194,1295,837,788,187,461,551,2395,2722,1359,3489,2769,2663,3938,3,639,1379,332,445,3183,2719,848,2322,1243,3840,3177,1702,3302,3310,1648,3456,610,2806,126,3024,1755,1525,1327,1734,2995,2694,3928,1749,2219,2027,466,3188,358,2857,1438,2953,3300,1382,65,421,1582,3790,976,3562,1799,1731,1566,2755,1895,1342,1881,1835,1320,3014,3826,549,1194,2392,3393,3286,3786,1366,573,3619,1920,2430,1990,484,3008,2828,3690,2695,3215,3946,3930,3185,2423,1289,270,1874,3858,1523,255,3115,2404,1883,2959,182,632,2994,2035,3176,1690,692,3409,1415,495,1762,382,2796,1867,2049,273,486,3306,846,711,103,586,1544,75,200,397,3048,2844,2532,2450,3113,2448,201,1339,1993,3851,1601,2088,1932,2026,193,3720,528,1477,2596,1848,2516,824,1649,3577,1904,1517,3285,830,3868,2706,2042,2965,565,938,2655,3439,197,330,3616,1801,1624,879,737,2627,3492,3428,418,3707,1590,1527,1282,2447,2016,3073,3912,116,217,266,2794,2520,1501,2626,3715,2678,2031,2709,1941,511,353,2594,2569,3266,870,2205,2167,25,1613,3086,3759,808,207,3438,309,1202,3824,2106,1958,2032,3142,1174,1330,1369,3346,992,1586,1681,74,462,967,2173,1371,3745,550,1923,427,2461,3565,2929,1334,48,1123,714,1055,1918,2148,1216,2386,2721,1348,935,585,1367,2113,2498,2691,1856,2286,3351,3320,444,3566,1427,2820,2660,736,839,1591,2644,937,2005,867,1670,1997,234,2377,663,3447,390,1058,2665,849,1479,2810,1869,190,360,3632,172,1732,3761,312,1454,241,2649,2617,691,2772,3920,202,1113,1611,107,512,558,3617,3528,2279,2128,1453,2713,2119,3355,2072,780,2102,637,1206,1551,984,2637,1588,3325,2900,1034,3326,2451,105,2715,1535,1562,742,3670,3483,3133,63,2499,2154,3706,3623,3127,2504,1992,3052,2059,881,3488,1380,2372,180,282,2505,1882,2625,205,1410,140,2399,1445,600,2232,3058,1005,2554,3717,2689,1717,3665,135,1606,1105,2589,3031,3674,1831,1822,1933,1602,3354,978,2149,1114,2741,784,3554,2551,3349,896,1604,3112,2519,656,3238,54,1331,3661,3787,2033,1261,785,240,2630,170,2412,487,2597,1450,1816,3357,1981,1021,1426,2151,2478,408,3092,118,716,1888,509,1699,3646,3093,875,2307,1054,3125,1298,2628,3432,2265,2979,148,3117,2793,3853,1581,996,352,2975,840,2098,1474,3106,188,3924,2165,3725,3399,2514,3612,2590,1728,1798,465,2781,208,1046,81,2500,405,168,3287,671,1475,3503,3663,3918,2050,3855,233,3043,3160,3886,1035,2853,3319,829,3404,1890,2304,2487,2638,3942,1974,2840,1689,2651,2780,2661,2513,2256,3444,1855,3865,1836,1696,1573,2364,704,2633,1982,1970,1014,2413,2645,3453,177,2116,2856,1439,1646,1071,1636,2679,3293,3273,3208,2826,344,2506,1665,1554,1406,1969,542,3150,3344,3837,2195,2107,333,1850,3419,1306,1973,2257,3477,199,2051,818,1640,2723,1644,1627,3784,3124,1975,2786,2446,575,3658,1926,3782,3816,104,3795,1771,1814,801,3568,2683,2656,3736,1417,2492,1991,3758,1626,3272,1373,1806,3181,3163,3902,3571,1312,1756,137,747,796,834,2821,3333,3575,634,2482,3119,3407,3772,3899,2004,3036,2162,2318,968,842,3688,1772,3064,2239,336,1549,1353,1153,2696,2468,2411,1126,3431,1897,2730,3531,313,877,3013,2837,2901,1310,3484,3889,2462,3070,2718,1707,258,1983,386,2878,3611,3883,152,3903,1825,2297,3459,3739,3586,970,2768,501,2338,3830,2122,1651,3908,1436,2549,2227,1059,1458,3776,520,1721,1539,2197,2914,3662,3660,1004,174,3921,1088,1916,1428,2961,203,2491,2093,631,3033,1703,2586,2785,2260,3743,674,659,680,325,2566,3540,3820,3275,2435,2163,2862,3053,3914,3511,807,3719,3794,2774,2159,2600,19,70,3532,3752,3825,3221,2328,2552,2667,2306,2389,2021,3235,3947,506,2041,3822,3139,1592,1391,1655,3446,1183,3608,665,3324,2388,3515,3850,1666,1026,583,124,3838,2296,1986,3821,1347,239,1255,2495,3535,1405,2164,2809,175,429,1980,1977,250,3457,3627,2052,3900,669,626,449,55,526,2996,2337,2976,2646,1354,2635,157,2733,2681,347,119,743,315,2497,1887,3018,2056,2904,961,3896,775,2363,1529,1676,1917,2582,2452,2647,12,2653,2326,2060,1837,2238,2992,2157,3775,2169,525,3894,3862,2938,310,2861,957,3696,1978,2431,2354,3054,1489,2022,2560,630,2244,2427,769,2888,3693,1859,469,2253,2335,3833,3915,15,1753,2550,1464,567,532,3598,1173,3785,392,1565,1901,3652,2091,1456,3146,1866,2666,267,2365,1812,3335,3867,3934,1979,2460,2876,2813,3464,1000,3901,2700,1567,891,407,2907,1460,366,3933,3597,2384,3416,3579,2977,1999,1067,1750,3917,2152,3262,1984,3156,1574,2101,1884,1780,3523,1328,828,2170,216,3777,2650,3874,3910,3943,2897,2209,1497,3754,3941,2084,3533,1416,888,3433,1063,2767,1502,2674,2131,696,749,985,1652,2623,2887,2960,3322,2712,97,2657,1669,3327,84,2305,815,3676,2775,3878,1232,1902,1546,3400,3857,3922,1355,611,2342,1985,3746,3673,3885,876,2315,570,1468,327,2882,2559,2981,3940,2387,3544,2129,2831,3003,166,3757,297,3587,1725,1726,343,1715,1877,2127,1846,1205,2834,2652,2361,3880,2325,3596,885,1654,2606,2658,735,2156,264,980,1433,3225,238,2211,2864,288,3309,1662,3592,3939,2704,1151,2892,2710,1872,960,3780,1483,3749,231,56,3843,939,2773,2893,1160,2602,3434,1570,2998,2459,2933,2984,3149,496,2545,1471,3520,1313,2886,1809,2962,2675,3781,1575,1329,2512,3626,751,1692,3340,3050,2776,618,3944,3864,1534,2833,3490,2830,3415,3486,718,2426,2314,3718,1743,3645,3303,3659,1543,2765,2850,2911,754,3804,1793,59,2362,1163,3636,2800,3818,1899,2913,2275,2507,146,37,130,192,401,591,607,690,776,789,821,1102,1133,1528,1555,1868,1930,2198,2258,2591,2777,2955,3288,3542,3748,3839,793,3021,841,411,2221,1924,1138,2673,1241,38,3778,3437,3847,136,2332,3641,1585,820,1553,2158,106,3012,3140,2760,2934,2557,666,729,2869,3603,3569,1493,874,2632,2964,3892,3913,108,1659,3817,2562,3875,1164,2538,1421,2192,2483,823,981,1886,3314,3866,1349,682,687,1149,1420,3136,3232,3380,854,2063,2705,3595,3205,2823,1796,559,2825,3216,138,706,887,1360,1773,1787,3085,3236,3294,3828,3800,572]

#############
# Load data #
#############
movies = pd.read_csv(os.path.join(cwd, 'ml-1m', 'movies.dat'),
                     delimiter='::', engine= 'python', header=None,
                     names=['movie_id', 'movie_name', 'genre'], encoding="ISO-8859-1")
users = pd.read_csv(os.path.join(cwd, 'ml-1m', 'users.dat'),
                    delimiter='::', engine='python', header=None,
                    names=['user_id', 'gender', 'age', 'occupation', 'zip_code'])
users['gender'] = users['gender'].replace(['M', 'F'], [0, 1])
ratings = pd.read_csv(os.path.join(cwd, 'ml-1m', 'ratings.dat'),
                      delimiter='::', engine='python', header=None,
                      names=['user_id', 'movie_id', 'rating', 'time'])

##########################
# Movies fairness scores #
##########################

movies_fairness_score = []
for _, movie in movies.iterrows():
    score = -1.0
    if "Adventure" in movie['genre'] or "Comedy" in movie['genre'] or "Documentary" in movie['genre'] or "Drama" in movie['genre'] or "Fantasy" in movie['genre']:
        score = 0.0
    if "Animation" in movie['genre'] or "Children's" in movie['genre'] or "Musical" in movie['genre'] or "Romance" in movie['genre']:
        score = 1.0
    movies_fairness_score.append(score)
movies_fairness_score = np.array(movies_fairness_score)

################################################
# Split the data to train, test and validation #
################################################
train_users, test_users = np.split(users.sample(frac=1, random_state=42), [int(.8*len(users))])
train_ratings = ratings[ratings['user_id'].isin(train_users['user_id'].unique())]
test_ratings = ratings[ratings['user_id'].isin(test_users['user_id'].unique())]
# Random
if args.type == 'random':
    for user in test_users['user_id'].unique():
        selected_ratings = test_ratings[test_ratings['user_id']==user].sample(n=number_of_samples, random_state=42)
        train_ratings = pd.concat([train_ratings, selected_ratings], ignore_index=True)
        train_ratings.reset_index()
        test_ratings.drop(selected_ratings.index, inplace=True)
# Most popular
if args.type == 'popular':
    for user in test_users['user_id'].unique():
        popular_samples = 0
        selected_user_ratings = test_ratings[test_ratings['user_id']==user]
        i = 0
        while popular_samples < number_of_samples and i < len(popular):
            movie_user_rating = selected_user_ratings[selected_user_ratings['movie_id']==popular[i]]
            if len(movie_user_rating) > 0:
                train_ratings = pd.concat([train_ratings, movie_user_rating], ignore_index=True)
                train_ratings.reset_index()
                test_ratings.drop(movie_user_rating.index, inplace=True)
                popular_samples = popular_samples+1
            i = i+1
# Most consensus
if args.type == 'consensus':
    for user in test_users['user_id'].unique():
        consensus_samples = 0
        selected_user_ratings = test_ratings[test_ratings['user_id']==user]
        i = 0
        while consensus_samples < number_of_samples and i < len(consensus):
            movie_user_rating = selected_user_ratings[selected_user_ratings['movie_id']==consensus[i]]
            if len(movie_user_rating) > 0:
                train_ratings = pd.concat([train_ratings, movie_user_rating], ignore_index=True)
                train_ratings.reset_index()
                test_ratings.drop(movie_user_rating.index, inplace=True)
                consensus_samples = consensus_samples+1
            i = i+1
# Most controversial
if args.type == 'controversial':
    for user in test_users['user_id'].unique():
        consensus_samples = 0
        selected_user_ratings = test_ratings[test_ratings['user_id']==user]
        i = len(consensus)-1
        while consensus_samples < number_of_samples and i >= 0:
            movie_user_rating = selected_user_ratings[selected_user_ratings['movie_id']==consensus[i]]
            if len(movie_user_rating) > 0:
                train_ratings = pd.concat([train_ratings, movie_user_rating], ignore_index=True)
                train_ratings.reset_index()
                test_ratings.drop(movie_user_rating.index, inplace=True)
                consensus_samples = consensus_samples+1
            i = i-1

###################
# Prepare dataset #
###################
dataset = Dataset()
dataset.fit(users['user_id'],
            movies['movie_id'],
            # ((x['gender'], x['age'], x['occupation'], x['zip_code']) for _, x in users.iterrows()),
            ["Gender", "Age", "Occupation"],
            ["Action", "Adventure", "Animation", "Children's", "Comedy", "Crime", "Documentary", "Drama", "Fantasy", "Film-Noir", "Horror", "Musical", "Mystery", "Romance", "Sci-Fi", "Thriller", "War", "Western"])
num_users, num_movies = dataset.interactions_shape()
(train_interactions, train_weights) = dataset.build_interactions(((x['user_id'], x['movie_id'], x['rating'])
                                                      for _, x in train_ratings.iterrows()))
(test_interactions, test_weights) = dataset.build_interactions(((x['user_id'], x['movie_id'], x['rating'])
                                                      for _, x in test_ratings.iterrows()))
user_features = dataset.build_user_features(((x['user_id'], {"Gender": float(x['gender']), "Age": float(x['age']), "Occupation": float(x['occupation'])})
                                              for _, x in users.iterrows()), normalize=False)
movie_features = dataset.build_item_features(((x['movie_id'], x['genre'].split('|'))
                                              for _, x in movies.iterrows()), normalize=False)

###################
# Build the model #
###################
warp_model = LightFM(loss='warp', random_state=96)
warp_model.fit(train_weights, user_features=user_features, item_features=movie_features, epochs=10)

############
# Evaluate #
############
train_auc = auc_score(warp_model,
                    test_weights,
                    train_weights,
                    user_features=user_features,
                    item_features=movie_features).mean()
if args.output == 'human':
    print('AUC warp_model: %s' % train_auc)
else:
    outputs.append(train_auc)
train_precision = precision_at_k(warp_model, test_weights, train_weights, k=args.k, user_features=user_features, item_features=movie_features).mean()
if args.output == 'human':
    print('Precision: %.2f' % train_precision)
else:
    outputs.append(train_precision)

###########
# Predict #
###########
list_of_unique_test_users = test_users['user_id'].unique()
prediction_scores = []
top_predictions = []
prediction_fair_scores = []
top_fair_predictions = []
same_predictions_scores = []
fairness_scores = []
non_fairness_scores = []
for i in range(len(list_of_unique_test_users)):
    user_prediction_scores = warp_model.predict(np.full(3883, list_of_unique_test_users[i]-1), np.arange(0, 3883), item_features=movie_features, user_features=user_features)
    user_prediction_scores /= np.max(np.abs(user_prediction_scores))
    user_prediction_fair_scores = user_prediction_scores*(1-args.ratio) + movies_fairness_score*args.ratio
    prediction_scores.append(user_prediction_scores)
    prediction_fair_scores.append(user_prediction_fair_scores)
    user_predictions = np.argsort(-user_prediction_scores)
    user_top_predictions = user_predictions[:args.k]
    top_predictions.append(user_top_predictions)
    user_fair_predictions = np.argsort(-user_prediction_fair_scores)
    user_top_fair_predictions = user_fair_predictions[:args.k]
    top_fair_predictions.append(user_top_fair_predictions)
    user_num_same_predictions = 0
    user_predictions_fairness_score = 0
    for prediction in user_top_fair_predictions:
        if prediction in user_top_predictions:
            user_num_same_predictions = user_num_same_predictions + 1
        user_predictions_fairness_score = user_predictions_fairness_score + ((movies_fairness_score[prediction]+1)/2)
    same_predictions_scores.append(user_num_same_predictions/args.k)
    fairness_scores.append(user_predictions_fairness_score/args.k)
    user_predictions_non_fairness_score = 0
    for prediction in user_top_predictions:
        user_predictions_non_fairness_score = user_predictions_non_fairness_score + ((movies_fairness_score[prediction]+1)/2)
    non_fairness_scores.append(user_predictions_non_fairness_score/args.k)
fairness_prediction = sum(same_predictions_scores) / len(same_predictions_scores)
if args.output == 'human':
    print('Fairness prediction score: %.2f' % fairness_prediction)
else:
    outputs.append(fairness_prediction)
fairness_score = sum(fairness_scores) / len(fairness_scores)
if args.output == 'human':
    print('Fairness score: %.2f' % fairness_score)
else:
    outputs.append(fairness_score)
non_fairness_score = sum(non_fairness_scores) / len(non_fairness_scores)
if args.output == 'human':
    print('Non-fairness score: %.2f' % non_fairness_score)
else:
    outputs.append(non_fairness_score)
if args.output == 'machine':
    print('%s,%d,%.1f,%d,%.2f,%.2f,%.2f,%.2f,%.2f' % (args.type, args.samples, args.ratio, args.k, outputs[0], outputs[1], outputs[2], outputs[3], outputs[4]))